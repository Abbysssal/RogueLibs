# Объединяемые предметы

import Tabs from '@site/src/components/Tabs';
import TabItem from '@site/src/components/TabItem';
import useBaseUrl from '@docusaurus/useBaseUrl';

## Делаем предметы объединяемыми

Просто реализуйте интерфейс `IItemCombinable` в классе вашего предмета:

```csharp
// highlight-next-line
public class MyCustomItem : CustomItem, IItemCombinable
{
    // highlight-start
    public void CombineItems(InvItem other)
    {
        ...
    }
    // highlight-end
}
```

:::note
При объединении, большинство предметов проигрывают анимацию с помощью `UseItemAnim`:
:::
:::note
Нужна GIF
:::

## Примеры

<Tabs
    defaultValue="grindstone"
    values={[
        {label:'Точильный камень', value:'grindstone'},
        {label:'Коробка с боеприпасами', value:'ammobox'},
    ]}>
<TabItem value="grindstone">

Простой пример. Использует особые атрибуты для предметов (функциональность добавлена в патчах).

```csharp title="Grindstone.cs"
[ItemCategories(RogueCategories.Technology, RogueCategories.MeleeAccessory, RogueCategories.Melee)]
public class Grindstone : CustomItem, IItemCombinable
{
    public override void SetupDetails()
    {
        Item.itemType = ItemTypes.Combine;
		Item.itemValue = 40;
		Item.initCount = 10;
		Item.rewardCount = 10;
		Item.hasCharges = true;
		Item.stackable = true;
    }
    public bool CombineFilter(InvItem other)
        => other.itemType == ItemTypes.WeaponMelee && !other.contents.Exists(c => c.StartsWith("Sharpened:"));
    public void CombineItems(InvItem other)
    {
        other.contents.Add("Sharpened:3");
        Count--;
		UseItemAnim();
    }
    public CustomTooltip CombineTooltip(InvItem other) => null;
}
```

```csharp
RogueLibs.CreateCustomItem<Grindstone>()
    .WithName(new CustomNameInfo("Grindstone")
    { Russian = "Точильный камень" })
    .WithDescription(new CustomNameInfo("Use on melee weapons to sharpen them. Sharpened weapons will ignore all damage-reducing effects.")
    { Russian = "Используйте на оружии ближнего боя чтобы заточить их. Заточенное оружие игнорирует все защищающие эффекты." })
    .WithSprite(Properties.Resources.Grindstone)
    .WithUnlock(new ItemUnlock
    {
        UnlockCost = 10,
        CharacterCreationCost = 5,
        LoadoutCost = 5,
        // Спрей прочности оружия ближнего боя должен быть разблокирован, чтобы разблокировать Точильный камень
        Prerequisites = { "MeleeDurabilityDoubler" },
    });
```

</TabItem>
<TabItem value="ammobox">

Довольно сложный пример, с кучей арифметики.

```csharp title="AmmoBox.cs"
[ItemCategories(RogueCategories.Technology, RogueCategories.GunAccessory, RogueCategories.Guns)]
public class AmmoBox : CustomItem, IItemCombinable
{
    public override void SetupDetails()
    {
        Item.itemType = ItemTypes.Combine;
		Item.itemValue = 4;
		Item.initCount = 100;
		Item.rewardCount = 200;
		Item.hasCharges = true;
		Item.stackable = true;
    }
    public bool CombineFilter(InvItem other) => other.itemType == ItemTypes.WeaponProjectile && !other.noRefills;
    public void CombineItems(InvItem other)
    {
        int amountToRefill = other.maxAmmo - other.invItemCount;
		float singleCost = (float)other.itemValue / other.maxAmmo;
		if (Owner.oma.superSpecialAbility && (Owner.agentName == "Soldier" || Owner.agentName == "Doctor"))
			singleCost = 0f;
		if (other.invItemCount >= other.maxAmmo)
		{
			Owner.SayDialogue("AmmoDispenserFull");
			gc.audioHandler.Play(Owner, "CantDo");
		}

		int affordableAmount = (int)Mathf.Ceil(Count / singleCost);
		int willBeBought = Mathf.Min(affordableAmount, amountToRefill);
		int willBeReduced = (int)Mathf.Min(Count, willBeBought * singleCost);

        Count -= willBeReduced;
		other.invItemCount += willBeBought;
		Owner.SayDialogue("AmmoDispenserFilled");
		gc.audioHandler.Play(Owner, "BuyItem");
		UseItemAnim();
    }
    public CustomTooltip CombineTooltip(InvItem other)
    {
        // WIP: API ещё не стабильный. Сделаю позже.
        // Плюс, я не уверен, правильно ли эта штука считает или нет.
        if (other.invItemName == "AmmoBox") return null;

		int amountToRefill = other.maxAmmo - other.invItemCount;
		if (amountToRefill == 0) return null;

		float singleCost = (float)other.itemValue / other.maxAmmo;
		if (Owner.oma.superSpecialAbility && (Owner.agentName == "Soldier" || Owner.agentName == "Doctor"))
			singleCost = 0f;
		int cost = (int)Mathf.Floor(amountToRefill * singleCost);
		int canAfford = (int)Mathf.Ceil(Count / singleCost);

		return "+" + Mathf.Min(amountToRefill, canAfford) + " (" + Mathf.Min(cost, Count) + ")";
    }
}
```

```csharp
RogueLibs.CreateCustomItem<AmmoBox>()
    .WithName(new CustomNameInfo("Ammo Box")
    { Russian = "Коробка с боеприпасами" })
    .WithDescription(new CustomNameInfo("Combine with any refillable weapon to refill it. Limited ammo.")
    { Russian = "Объедините с любым пополняемым оружием дальнего боя чтобы пополнить его боезапас. Ограниченный боезапас." })
    .WithSprite(Properties.Resources.AmmoBox)
    .WithUnlock(new ItemUnlock
    {
        UnlockCost = 10,
        CharacterCreationCost = 3,
        LoadoutCost = 3,
        // Портативный раздатчик боеприпасов должен быть разблокирован, чтобы разблокировать Коробку с боеприпасами
        // Портативный раздатчик боеприпасов - тоже кастомный предмет
        Prerequisites = { nameof(PortableAmmoDispenser) },
    });
```

</TabItem>
</Tabs>